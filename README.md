# "Живи с умом!" (c) Смешарики
## Задачи
мой умный дом решает следующие задачи:
1. стабильный и быстрый интернет для всех пользователей, в том числе 10Гбс канал до НАСа и 2.5 до компьютера.
2. отдельные сети для гостей, умных устройств с доступом только к интернету, к интернету и домашней сети, только к домашней сети.
3. локальные киношки и сериальчики с максимальным удобством и качеством для всех желающих.
4. семейный фотоархив с макс.удобством и обязательным бэкапом фоток с гаджетов и всей коллекции. Ограниченный доступ к фотоархиву из публичных сетей. 
5. семейный документооборот - печать, сканирование, индексирование, надежное хранение и поиск по всем документам и бумажной переписке.
6. управление с помощью голоса либо присутствия светом и другими умными устройствами. Приоритет всегда где возможно отдается локальному доступу с минимумом облачных технологий.
7. внешний доступ через ВПН для семьи + шаринг моего интернета с внешними пользователями для обхода ограничений.
8. хранилище паролей для всей семьи с возможностью безопасного доступа и интеграциями с большинством устройств.
9. резалка рекламы, в основном, для умных устройств - телевизора, игровых приставок и т.д.
10. контроль детского доступа к интернету и отдельным сервисам (ТикТок, Ютюб и т.д.).
11. иногда вебсервер с доступом из интернета для каких-то нишевых задач. 

## Железо
![Схема сети](Pictures/home_net.jpg)

### NAS в качестве домашнего сервера
Основа моего умного дома - NAS Synology DS723+. Все детали про свой НАС я вынес в [отдельный раздел](https://github.com/ageev/SmartHome/blob/master/SynologyNAS/README.md). 
Я долго думал о платформе для домашнего дома и всё таки остановился на Synology. Почему? Главным образом из-за надежности и низкого энергопотребления. Из минусов - это замкнутая система, не опенсорс. И Synology с каждым годом замыкает её всё сильнее. 

### Роутер

На роутеры АСУС существует кастомная прошивка от merlin. Однако только свежие модели получают интересные фичи. Подробней смотри в папке [ASUS Router](ASUS%20Router/README.MD)
И всё же я не могу порекомендовать АСУС. У меня много нервов на него ушло, интерфейс "застрял в двухтысячных", и там и тут нужны костыли, хотя коммунити живёт и костыли исправно выходят.

### 10Gbps
У меня входящий и исходящий интернет канал - 10 Гб/c. Сколько-нибудь эффективно использовать такой канал непросто. 
- 10Гб/с это горячо. Большинство SPF+ модулей прогреваются до 70 градусов, из-за чего в замкнутых пространствах растёт температура. Так что готовьтесь постоянно прогонять кота с роутера. Карта расширения 10 Гб/с от Synology прогревает жетские диски моего НАСа, как минимум, на 2 градуса.  
- Есть сложности с выбором медиаконвертера и/или SPF+ модуля, подходящего под вашего провайдера и ваш роутер. Есть высокий шанс, что что-то в итоге окажется несовместимым.
- Не все роутеры тянут 10 Гб/с и не при всех условиях. Наличие нужного порта ещё ничего не значит. Даже если вы думаете, что ваш роутер не тянет (iperf3 выдает всего пару гигабит), проблема может быть не в роутере, а в способе измерения: ни встроенный измеритель скорости Asus, ни iperf3 установленный на роутере, ни iperf3 запущенный в докер контейнере на НАСе не показывают мне ничего близкого к 10 Гб/c. Только iPerf3 из состава community-пакета Synology SynoCli Monitor Tools показывает правильную скорость, да и то не всегда (иногда сервер на той стороне может так же резать скорость).
- Не все 10 Гб/с кабеля дают 10 Гб/с скорость. Чем длиннее кабель - тем более вероятно, что пакеты будут прилетать с ошибками. Не факт, что толстый кабель даст большую скорость. Только методом проб и ошибок (а так же тестом на коротких расстояниях) можно найти нужный кабель. К тому же брендовые патчкорды не всегда пролезут в дырки, так что где можно используйте оптику. Если кабеля уже проложены в стенах (как у меня), то открытием оказались угловые коннекторы (angled network cable).
- 10 Гб/с у меня идёт от роутера до НАСа. Остальные клиенты получают 2.5/1 gbps. Насколько НАС использует эти 10 gbps, конечно, большой вопрос, но вот 2.5 gbps от НАСа до стационарного компьютера заметно помогают.  

### В путешествиях

Когда мы надолго куда-нибудь уезжаем, я беру с собой "умный дом лайт"
![Схема сети для путешествий](Pictures/travel_net.jpg)

Воткнуть свой роутер в сеть отеля - это удобно. Не нужно подключать планшеты/телефоны/ноутбуки к новому вайфаю, т.к. на роутере настроена домашняя сеть. Быстрый вайфай + встроенный ВПН до дома чтобы, например, скачать кино. Мини Алиса (с USB-c!) и умная розетка позволяют выключать свет не вставая с дивана (супер опция для тех, кто проходил весь день). 
Модем Huawei, даже прошитый хакнутой прошивкой - опция так себе. Как-нибудь проапгрейжу до внешнего кейса + miniPCI WAN карты (на 4pda отличная тема про [это](https://4pda.to/forum/index.php?showtopic=994474)).
Роутеры gl.inet - прям отличные устройства, если нужна мобильность! Удобный интерфейс с резалкой рекламы + OpenWRT внутри. 
Amazon Fire TV 4k Pro - лучший стик, на распродаже оч дёшев. Можно убрать всё гавно от Амазона (см @amazonfiretvrus в телеге), поставить [FLauncher](https://gitlab.com/flauncher/flauncher), [SmartTubeNext](https://github.com/yuliskov/SmartTubeNext), [AerialView](https://github.com/theothernt/AerialViews), NUM - No UI Movies и Kodi

## Софт
![Стартовая страница Homer](Pictures/start_page.jpg)

Вот так выглядит домашний веб сервер Homer (ниже про него подробней)
На НАСе крутятся:
- [Docker](https://github.com/ageev/SmartHome/blob/master/docker/README.MD) - всё самое важное крутится тут.
- Софт Synology
  - Synology Photos - отличный каталогизатор семейных фотографий. Я немного причесываю семейный архив [скриптами](https://github.com/ageev/others) время от времени
  - HyperBackup - универсальный бэкапер. Работает практически со всеми облаками и имеет очень гибкие политики бэкапа. Я бэкаплю много и часто, в основном, в Azure, предварительно всё хорошенько зашифровав
  - CloudSync - синхронизирует локальную папку на НАСе с каким-нибудь облаком
  - Virtual Machine Manager - тут у меня крутится VitrualDSM (виртуальный НАС) и Home Assistant OS.
  - Surveillance Station - отличный менеджер камер наблюдения
  - НАС шарит папку Media со всей домашней сетью, где лежат скачанные фильмы
- Python скрипты, которые я запускаю через планировщик Synology. Их состав меняется со временем. Сейчас такой:
  - Скрипты для [работы с фото]().
  - Скрипты от [007revad](https://github.com/007revad) для работы с НАСом:
    - для включения поддержки HEIC в Synology Photos (007revad/Video_Station_for_DSM_722)
    - для перемещения всех приложений на SSD (syno_app_mover)
    - для добавления используемых жестких дисков и ССД в список "официально поддерживаемых дисков" Synology чтобы обойти вендорлок (syno_hdd_db)
    - для удаления мусора из докера (syno_docker_cleanup)
  - Скрипты-снайперы, которые я пишу когда мне нужно что-то отслеживать.
  - Скрипт для обновления ["режима разработчика"](https://github.com/webosbrew/dev-manager-desktop) на телевизорах LG чтоб можно было запускать свои apk файлы.
